<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë˜ë˜ë§ˆì¼“ WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        display: flex;
        gap: 20px;
        padding: 20px;
      }
      .container {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 8px;
        width: 45%;
      }
      h2 {
        margin-top: 0;
      }
      input[type="text"],
      input[type="number"] {
        width: 95%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        padding: 8px 12px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #aaa;
      }
      #logs {
        white-space: pre-wrap;
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        padding: 10px;
        height: 300px;
        overflow-y: scroll;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>1. ì—°ê²° ì„¤ì •</h2>
      <input
        type="text"
        id="jwt"
        placeholder="ì—¬ê¸°ì— JWT í† í°ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
      />
      <button onclick="connect()">ì—°ê²°</button>
      <button onclick="disconnect()" id="disconnectBtn" disabled>
        ì—°ê²° ëŠê¸°
      </button>
    </div>

    <div class="container">
      <h2>2. êµ¬ë… ë° ë©”ì‹œì§€ ì „ì†¡</h2>
      <div>
        <input type="number" id="roomId" placeholder="ì±„íŒ…ë°© ID (ì˜ˆ: 1)" />
        <button onclick="subscribe()" id="subscribeBtn" disabled>êµ¬ë…</button>
        <button onclick="unsubscribe()" id="unsubscribeBtn" disabled>
          êµ¬ë… ì·¨ì†Œ
        </button>
      </div>
      <div>
        <input type="text" id="message" placeholder="ë³´ë‚¼ ë©”ì‹œì§€" />
        <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
      </div>
      <h2>ë¡œê·¸ ë° ìˆ˜ì‹  ë©”ì‹œì§€</h2>
      <pre id="logs"></pre>
    </div>

    <script>
      let stompClient = null;
      let subscription = null;

      function log(message) {
        document.getElementById("logs").innerHTML += message + "\n";
      }

      function setConnected(connected) {
        document.getElementById("disconnectBtn").disabled = !connected;
        document.getElementById("subscribeBtn").disabled = !connected;
        document.getElementById("sendBtn").disabled = !connected;
      }

      function connect() {
        const token = document.getElementById("jwt").value;
        if (!token) {
          alert("JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // 1. SockJSë¥¼ ì‚¬ìš©í•œ ì›¹ì†Œì¼“ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        const socket = new SockJS("http://localhost:8080/ws-stomp");
        stompClient = Stomp.over(socket);

        // 2. í—¤ë”ì— JWT í† í° ì„¤ì •
        const headers = {
          Authorization: "Bearer " + token,
        };

        // 3. ì—°ê²°
        stompClient.connect(
          headers,
          function (frame) {
            log("âœ… ì—°ê²° ì„±ê³µ: " + frame);
            setConnected(true);
          },
          function (error) {
            log("âŒ ì—°ê²° ì‹¤íŒ¨: " + error);
          }
        );
      }

      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect(() => {
            log("ğŸ”Œ ì—°ê²° ëŠê¹€");
            setConnected(false);
            document.getElementById("unsubscribeBtn").disabled = true;
            subscription = null;
          });
        }
      }

      function subscribe() {
        const roomId = document.getElementById("roomId").value;
        if (!roomId) {
          alert("ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        const destination = "/topic/chat/room/" + roomId;

        subscription = stompClient.subscribe(destination, function (message) {
          log("ğŸ“¬ ë©”ì‹œì§€ ìˆ˜ì‹ : " + message.body);
        });

        log(`ğŸ“Œ [${destination}] êµ¬ë… ì‹œì‘`);
        document.getElementById("unsubscribeBtn").disabled = false;
      }

      function unsubscribe() {
        if (subscription) {
          subscription.unsubscribe();
          log(`ğŸš« [${subscription.id}] êµ¬ë… ì·¨ì†Œ`);
          document.getElementById("unsubscribeBtn").disabled = true;
          subscription = null;
        }
      }

      function sendMessage() {
        const roomId = document.getElementById("roomId").value;
        const messageContent = document.getElementById("message").value;
        if (!roomId || !messageContent) {
          alert("ì±„íŒ…ë°© IDì™€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const destination = "/app/chat/message/" + roomId;
        const message = {
          message: messageContent,
        };

        stompClient.send(destination, {}, JSON.stringify(message));
        log(`ğŸš€ ë©”ì‹œì§€ ì „ì†¡: ${messageContent}`);
      }
    </script>
  </body>
</html>
